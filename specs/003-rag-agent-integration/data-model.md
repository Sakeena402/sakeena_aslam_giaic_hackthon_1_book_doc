# Data Model: Agent-Based RAG Integration

## Core Entities

### AgentQuery
Represents a query submitted to the AI agent
- **query_text**: String - The natural language query from the user
- **query_type**: Enum (global|section_specific) - Whether to search entire book or specific section
- **section_filter**: String (optional) - Which section/chapter to restrict search to
- **created_at**: DateTime - When the query was submitted
- **user_context**: Object (optional) - Additional context about the user or session

### RetrievedChunk
Represents a content chunk retrieved from Qdrant for grounding
- **id**: String - Unique identifier for the chunk
- **content**: String - The actual content text
- **similarity_score**: Float - Similarity score from vector search (0.0-1.0)
- **metadata**: Object - Additional metadata (url, title, chunk_index, etc.)
- **source_url**: String - Original URL of the content
- **chunk_index**: Integer - Position of chunk in original document
- **retrieved_at**: DateTime - When chunk was retrieved

### AgentResponse
Represents the final response generated by the AI agent
- **id**: String - Unique identifier for the response
- **query_id**: String - Reference to the original query
- **response_text**: String - The generated response text
- **grounding_chunks**: Array[RetrievedChunk] - Chunks used to ground the response
- **confidence_score**: Float - Confidence in the response quality
- **generated_at**: DateTime - When response was generated
- **tokens_used**: Integer - Number of tokens consumed in generation

### AgentSession
Represents a conversation session with the agent
- **session_id**: String - Unique identifier for the session
- **user_id**: String (optional) - Identifier for the user
- **created_at**: DateTime - When session started
- **last_interaction**: DateTime - When last query was processed
- **conversation_history**: Array[Object] - History of query-response pairs

### RetrievalContext
Encapsulates the context for a retrieval operation
- **query_embedding**: Array[Float] - Vector representation of the query
- **collection_name**: String - Name of Qdrant collection to search
- **top_k**: Integer - Number of results to retrieve
- **similarity_threshold**: Float - Minimum similarity for inclusion
- **filters**: Object (optional) - Additional filters for scoped retrieval
- **search_params**: Object - Additional search parameters

## Relationships

- An `AgentQuery` generates zero or more `RetrievedChunk` objects during retrieval
- An `AgentQuery` produces one `AgentResponse`
- An `AgentSession` contains multiple `AgentQuery` and `AgentResponse` pairs
- An `AgentResponse` references multiple `RetrievedChunk` objects for grounding
- A `RetrievedChunk` originates from the content extraction pipeline and is linked to source content

## Validation Rules

### AgentQuery
- `query_text` must be non-empty (min 3 characters)
- `query_type` must be either "global" or "section_specific"
- If `query_type` is "section_specific", `section_filter` must be provided

### RetrievedChunk
- `content` must be non-empty
- `similarity_score` must be between 0.0 and 1.0
- `chunk_index` must be non-negative

### AgentResponse
- `response_text` must be non-empty
- `confidence_score` must be between 0.0 and 1.0
- Must have at least one grounding chunk in `grounding_chunks`

### AgentSession
- `session_id` must be unique
- `created_at` must be before `last_interaction` (if set)